{
  "entities": {
    "Video": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Video",
      "type": "object",
      "description": "Represents a video exercise in the library.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Video entity."
        },
        "title": {
          "type": "string",
          "description": "Title of the video."
        },
        "description": {
          "type": "string",
          "description": "Detailed description of the video exercise."
        },
        "url": {
          "type": "string",
          "description": "URL of the video on Rutube/YouTube.",
          "format": "uri"
        },
        "previewUrl": {
          "type": "string",
          "description": "URL of the video preview image.",
          "format": "uri"
        },
        "duration": {
          "type": "number",
          "description": "Duration of the video in seconds."
        },
        "bodyZone": {
          "type": "string",
          "description": "The body zone the video relates to (e.g. 'neck', 'back', 'legs')."
        },
        "restrictions": {
          "type": "string",
          "description": "Restrictions or contraindications for the video exercise."
        }
      },
      "required": [
        "id",
        "title",
        "description",
        "url",
        "duration",
        "bodyZone"
      ]
    },
    "Patient": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Patient",
      "type": "object",
      "description": "Represents a patient profile.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Patient entity."
        },
        "firstName": {
          "type": "string",
          "description": "First name of the patient."
        },
        "lastName": {
          "type": "string",
          "description": "Last name of the patient."
        },
        "dateOfBirth": {
          "type": "string",
          "description": "Date of birth of the patient.",
          "format": "date-time"
        },
        "contactNumber": {
          "type": "string",
          "description": "Contact number of the patient."
        }
      },
      "required": [
        "id",
        "firstName",
        "lastName",
        "dateOfBirth"
      ]
    },
    "VideoAssignment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "VideoAssignment",
      "type": "object",
      "description": "Represents an assignment of a video to a patient.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the VideoAssignment entity."
        },
        "patientId": {
          "type": "string",
          "description": "Reference to Patient. (Relationship: Patient 1:N VideoAssignment)"
        },
        "videoId": {
          "type": "string",
          "description": "Reference to Video. (Relationship: Video 1:N VideoAssignment)"
        },
        "duration": {
          "type": "number",
          "description": "Prescribed duration of the video for this assignment."
        },
        "order": {
          "type": "number",
          "description": "Order in which the video should be performed."
        },
        "comments": {
          "type": "string",
          "description": "Additional comments or instructions for the patient."
        }
      },
      "required": [
        "id",
        "patientId",
        "videoId",
        "duration",
        "order"
      ]
    },
    "Template": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Template",
      "type": "object",
      "description": "Represents a reusable template for video assignments.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Template entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the template."
        },
        "description": {
          "type": "string",
          "description": "Description of the template."
        },
        "videoIds": {
          "type": "array",
          "description": "References to Videos. (Relationship: Template 1:N Video)",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "name",
        "description",
        "videoIds"
      ]
    },
    "ActivityLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ActivityLog",
      "type": "object",
      "description": "Represents a log of patient activity (e.g., video opens).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ActivityLog entity."
        },
        "patientId": {
          "type": "string",
          "description": "Reference to Patient. (Relationship: Patient 1:N ActivityLog)"
        },
        "videoId": {
          "type": "string",
          "description": "Reference to Video. (Relationship: Video 1:N ActivityLog)"
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of the activity log entry.",
          "format": "date-time"
        },
        "activityType": {
          "type": "string",
          "description": "Type of recorded activity (e.g., 'videoOpened')."
        }
      },
      "required": [
        "id",
        "patientId",
        "videoId",
        "timestamp",
        "activityType"
      ]
    }
  },
  "auth": {
    "providers": [
      "password"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/videos/{videoId}",
        "definition": {
          "entityName": "Video",
          "schema": {
            "$ref": "#/backend/entities/Video"
          },
          "description": "Stores video exercise information. Includes details like title, description, URL, duration, body zone, and restrictions. Doctors can create and manage videos.",
          "params": [
            {
              "name": "videoId",
              "description": "The unique identifier of the video."
            }
          ]
        }
      },
      {
        "path": "/patients/{patientId}",
        "definition": {
          "entityName": "Patient",
          "schema": {
            "$ref": "#/backend/entities/Patient"
          },
          "description": "Stores patient profile information. Doctors can create and manage patient profiles.",
          "params": [
            {
              "name": "patientId",
              "description": "The unique identifier of the patient."
            }
          ]
        }
      },
      {
        "path": "/patients/{patientId}/videoAssignments/{videoAssignmentId}",
        "definition": {
          "entityName": "VideoAssignment",
          "schema": {
            "$ref": "#/backend/entities/VideoAssignment"
          },
          "description": "Stores video assignments for a specific patient. Includes denormalized 'patientId' via path and videoId, duration, order, and comments.  Used to assign videos to patients.",
          "params": [
            {
              "name": "patientId",
              "description": "The unique identifier of the patient."
            },
            {
              "name": "videoAssignmentId",
              "description": "The unique identifier of the video assignment."
            }
          ]
        }
      },
      {
        "path": "/templates/{templateId}",
        "definition": {
          "entityName": "Template",
          "schema": {
            "$ref": "#/backend/entities/Template"
          },
          "description": "Stores reusable templates for video assignments. Includes template name, description, and a list of videoIds.",
          "params": [
            {
              "name": "templateId",
              "description": "The unique identifier of the template."
            }
          ]
        }
      },
      {
        "path": "/patients/{patientId}/activityLogs/{activityLogId}",
        "definition": {
          "entityName": "ActivityLog",
          "schema": {
            "$ref": "#/backend/entities/ActivityLog"
          },
          "description": "Stores activity logs for a specific patient, tracking when patients open videos. Includes denormalized 'patientId' via path, videoId, timestamp, and activity type.",
          "params": [
            {
              "name": "patientId",
              "description": "The unique identifier of the patient."
            },
            {
              "name": "activityLogId",
              "description": "The unique identifier of the activity log entry."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to provide a secure, scalable, and debuggable solution for the 'Мой Остео' application, prioritizing authorization independence and clarity.  It addresses all app requirements, including video library management, patient management, personalized video assignments, template creation, patient access, activity logging, and the GenAI-powered complex generator tool.\n\n**Authorization Independence:**\nAuthorization Independence is achieved by adhering to strategy A, denormalizing authorization data.  For example, access to `videoAssignments` and `activityLogs` depends on the `patientId`. These collections are located under `/patients/{patientId}`, leveraging path-based ownership. This eliminates the need for `get()` calls in security rules to validate patient access, streamlining security rules and ensuring atomic operations. For collaborative entities, such as templates shared among practitioners (if needed in future), membership maps (`members: {uid: role}`) would be denormalized into documents to avoid `get()` calls, though this is not required in the current implementation.\n\n**Structural Segregation:**\nThe structure uses structural segregation (Strategy B) by placing related data under user-specific collections, such as `patients/{patientId}/videoAssignments`. This segregation ensures that all documents within a collection share the same security requirements. Public data, like the videos themselves, is stored separately in the `videos` collection with more open read access, and can be restricted if needed.\n\n**Access Modeling:**\nAccess modeling (Strategy C) follows consistent patterns:\n*   **Path-Based Ownership:** `/patients/{patientId}` and subcollections enforce ownership.  Only the authenticated user (practitioner) can manage patients and their associated data.\n*   **Global Roles (DBAC):** While not explicitly needed based on the requirements, a `roles_admin/{uid}` collection could be used to store administrator roles, checked by existence rather than content in security rules.\n\n**QAPs Support:**\nThe structure supports secure `list` operations (QAPs) through structural segregation. Listing video assignments for a patient is secured by path-based ownership: only the practitioner can list assignments under `/patients/{patientId}/videoAssignments`. Access to `videos` can be controlled to permit reads only, or limited to specific roles if necessary.\n\n**Invariants:**\nThe structure supports data invariants like ownership and timestamps. The `patientId` in `videoAssignments` is immutable due to the path-based ownership enforced by security rules. Timestamps within `activityLogs` can be validated using `request.time` in security rules.\n"
  }
}
    